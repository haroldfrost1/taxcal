#!/bin/bash

set -euo pipefail

echo "--- :gear: Post-command hook"

# Log out of Docker registries for security
if command -v docker &> /dev/null; then
  if [[ "${BUILDKITE_STEP_KEY:-}" == "publish" ]]; then
    echo "--- :lock: Logging out of Docker registry"
    docker logout "${DOCKER_REGISTRY:-docker.io}" || true
  fi
  
  # Clean up build artifacts but keep the final images for subsequent steps
  if [[ "${BUILDKITE_STEP_KEY:-}" == "build" ]]; then
    echo "--- :broom: Cleaning up intermediate build artifacts"
    docker image prune -f || true
  fi
fi

# Show step completion
case "${BUILDKITE_STEP_KEY:-}" in
  "test")
    echo "✅ Tests completed successfully"
    ;;
  "build")
    echo "✅ Docker image built successfully"
    ;;
  "publish")
    echo "✅ Docker image published successfully"
    ;;
  "security")
    echo "✅ Security scan completed"
    ;;
esac
