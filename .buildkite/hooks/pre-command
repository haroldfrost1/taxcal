#!/bin/bash

set -euo pipefail

echo "--- :gear: Pre-command hook"

# Set default environment variables if not provided
export DOCKER_REGISTRY="${DOCKER_REGISTRY:-docker.io}"
export DOCKER_USERNAME="${DOCKER_USERNAME:-$(whoami)}"

DOCKER_PASSWORD=$(buildkite-agent secret get docker_password)
export DOCKER_PASSWORD

if [[ -z "${DOCKER_PASSWORD:-}" ]]; then
  echo "❌ DOCKER_PASSWORD environment variable is required for publishing"
  exit 1
fi

# Validate required environment variables for publish steps
if [[ "${BUILDKITE_STEP_KEY:-}" == "publish" ]]; then
  if [[ -z "${DOCKER_USERNAME:-}" ]]; then
    echo "❌ DOCKER_USERNAME environment variable is required for publishing"
    exit 1
  fi
  
  if [[ -z "${DOCKER_PASSWORD:-}" ]]; then
    echo "❌ DOCKER_PASSWORD environment variable is required for publishing"
    exit 1
  fi
fi

# Print environment info
echo "Repository: ${BUILDKITE_REPO}"
echo "Commit: ${BUILDKITE_COMMIT}"
echo "Branch: ${BUILDKITE_BRANCH}"
echo "Docker Registry: ${DOCKER_REGISTRY}"
echo "Docker Username: ${DOCKER_USERNAME}"
